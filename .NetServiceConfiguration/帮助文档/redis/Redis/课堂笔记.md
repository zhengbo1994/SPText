# 课堂笔记

1.安装需要win10，或者会docker（你可以看上一期的录屏）

2.上课看到这个脚本和安装包，都会明天会给大家提供

3.如果你刚进来，之前没有看到，或者你在上课，有些知识点没天明白，用自己的电脑，先把问题记录下来

然后上完课之后，我们会统一答疑解惑

记住，看上面--- 

reids :数据库，，存储数据的仓库，它是内存数据库，然后提供了好多种数据类型，来解决我们不同业务的问题。。

nosql数据库的一种数据库，如果做缓存，优先选择redis。。

1.为什么在大数据高并发业务中，会要有redis？

IO阻塞问题。。





~~~shell
String
 这是一个简单的键值对操作。。
 redis 本身是一个内存数据，内存中的数据越来越多的时候，内存不是不够用了吗。可以给数据设置过期时间。。
  过期时间设置-1，是过多久过期，2是可以直接设置具体的日期
  
  使用场景：
  1.session 利用redis做session共享内存
  2.自增和自减法 -- 做一些网站的请求数量，或者论坛的点赞数，评论数，不可能每次都去执行数据库。。。 可以直接利用redis，操作内存，只不过到最后，做个数据刷盘，把这些统计数据放到我们硬盘中。。。
  string 底层 ： 在功能中，出了非必要的情况，除了上述这几个需求，尽量不要使用string类型
  底层会浪费大量的内存空间
   如果使用raw编码，则每次开辟空间都会留一些空间，如果数据长度变了，则内存也会继续变大。。
   如果你使用embstr ：它每次最多开辟64个字节的空间，只有44个字节时存储我们数据的。
   如果你在操作的redis的时候，内容长度小于等于44，则会自动选择embstr编码开辟空间
   如果你操作redis的时候，内容长度大于44的，使用ram编码，浪费 空间 
   还有一个int:只是针对于写的数据是数值，才行。。切记只有整型才是int类型  
  底层就是因为开辟的组件的原因。。。所以会浪费空间，尽量不要使用string。。除非你不在乎那些内存，就这样搞。。。  为什么要这样设置，给你一种选择。。。 
  
Hash
官网推荐使用hash 。。。
hash最典型的使用场景。。 
储存一个用户信息 
id,name,address,email 
如果使用string去存储，
key=userid 
values={id:1,name:'',address:'' ====}
如果需要修改其中木一个值，
先把数据拿到代码内存，然后反序列化，然后修改值，然后序列化--存储到redis
 如果直接使用hash，则值需要制定修改具体某一个字段的值就可以了 
 
下课把api自己调式走一下，使用场景，根据api来具体的领会，后面讲项目实践的时候，带大家分享，什么时候选择什么样的数据结构，当你处理业务的时候，操作的越简单，则选择数据类型就比较。。。

hash 底层，
ziplist,hash ?
ziplist:压缩版的list ..(动态的数组，数组的每一个元素的空间是一样的)
第一问题：每次插入都有开辟空间，连续的
第二问题：你要查询的时候，你要从头来计算，--查询的速度变慢。。。
hash的数据结果，它的时间复杂度是O(1);
hash快速的查询结果，而且节省空间，一上来就是一个小量的hash。。
问题：如果hash后面链表越来越长的时候，时间复杂度是不是又变高。。。
解决了这个问题？？
扩容：是一开始的时候，redis有两个hash结构在存储数据，第一次只要一个是有长度，一个是没有长度。。数据迁移问题来了，因为如果不小心操作的时候，刚好触发了瓶颈，要扩容，
解决迁移问题： 第一个：不是一次性迁移完成，是每一次操作只会迁移一部分。
                         第二个：是一个后台任务，后台任务给你偷偷摸摸的迁移数据：
                         非常重要：数据一致的问题：：自己有机会了解一下
                         
针对于hash get到的扣个1：不管是从内存还是性能方面，都是比较牛逼，所以官网推荐使用hash。。。扩容是有阈值。不会随便扩的。。 
List: 第一个是队列（先进先出）
      第二个是栈：（先进后出）
      第三个就是普通的集合。
      如果你要做插队，或者做队列，都可以使用list 
     集合设置过期，只能给整个集合设置，不能单独给某一个元素设置，没有给单独元素设置过期时间的策略。。
      遇到分页场景也可以使用。。。   
       消息队列： 记录日志
        程序报错--- 一种是文本日志，一种是数据库日志，，。 可以通过底层的消息队列来实现
        
        如果不想用list做消息队列，也可以直接用提供的专门的消息发布来做。。  特殊情况，公司不想要新的技术栈，就想用redis，  -- 提供一个扩展，不想了解也没有关系，知道这么回事就可以了  
        
Set：也是一个集合，只不过是一个去重的集合，
比如，比如我需要做投票-- 根据ip地址来投票，每一个ip只投一票。。。如果用list，需要我们自己来判断。如果使用set，则系统自动会去重。。。 取交集和去并集
a:{1,2,3,4,5}
b：{2,3,4,5,6}
a和b的交集= {2,3,4,5}
a和b的并集={1,2,3,4,5,6}
qq好友推荐里面用的比较多

Zset：也是去重的集合，具有set的功能，而且在这些功能里面加了一个值，分数。。。
使用场景，做服务注册于发现，抽奖。。。限流。。排行榜 。。。。 
提供了一个非常强大的功能，自动排序

数据结构底层：跳跃表  
 利用跳跃表，解决排序问题，把内容存在hash里面，把数值存在跳跃表里面，跳跃表里面的里面的数据是有顺序的。。。
 
 跳跃表在存放数据的时候，就把顺序搞好了。。。 --
 它不是解决存放的问题，它是损失一部分写的性能，来提升查询的性能
 跳跃表就相当于我们leven树。 一层上面有一层的大纲，后面我讲性能调优模块的时候，会单独讲数据结构和算法，给你提供.net跳跃表的源码 。。。。   
 
 zset默认是顺序查询，--我们默认查询是先根据分数来查询我们数据，我们的业务是尽量使用分数来查询，---有时间，可以听听上一期-- 课次数没有变--内容增多，希望大家，集合上一期。。api
 ,这一期api比较少，主要是原理-- 

2分钟：：：  

BitMaps
Hyperlogloss
Streams
Bloom Filter数据结构

~~~

## 答疑解惑

~~~shell
c# Socket.Select()Socket.Poll()的静态函数是多路复用吗
Windows平台的重叠IO概念就是多路复用吗
select 模型多路复用，性能还可以，但是没有linux,epool
生产环境中建议安装在linux系统中。。
~~~

~~~shell
1、window 环境下有进程的内存大小限制吧？redis在windows下最大可管理多少内存
可以配置的额，最后一次课讲解数据淘汰算法的时候，会讲到，怎么给redis设置最大内存限制。。
2、Exchange和CSRedisCore还有ServiceStack是不是API都一样（方法名称不一样，功能一样），只是性能不一样？
不一样，，ServiceStack是目前在生产环境中用的最多的，只不过破解，或者收费-- 
Exchange
3、数据淘汰机制如何设置
~~~

~~~she
问题：
1.windows上面生产环境跑5.0.10版本的redis的主要弊端是什么？
不能利于多路复用的epool模型。。。 只能使用select模型，最大能并发能支持1024个请求连接
2.hash里面的key可以存一个对象吗？api里面存一个对象里面套对象会怎么样？
redis里面的values只要是数数都可以写进去，因为写进去之前服务会做序列化
开发中，要么就是一个key，要么是string，要么就是json序列化的数组
~~~



~~~shell
Redis 安装到windows下是不是也不能多路复用
mysql在linux里面是不是也能实现IO多路复用（）
ngixn+redis 是用了多路复用

1.list 是否支持key 搜索 。。没懂这个问题

1 redis 设置了密码客户端加密码是这么加吗using (RedisClient client = new RedisClient("password@127.0.0.1"，6379))
2redis 的list 和我们泛型list 是不是区别不大？
不一样，底层不一样，.net 泛型list是一个安全类型的动态数组，redis里面的list代表的是一个类型，而不是数据结构，数据结构底层是之前的版本是双向链表，新版面是quiltlist(链表+ziplist)
3 今天 select和epllo没有讲清楚只讲了 多路复用io 非阻塞 
如果想要在java上面执行那个多路复用，如果拿到代码不会，运行不起来--- 少数人---
老师level是怎么分级的啊，什么时候分下一级啊
跳跃表：通过随机数，来要不要上升一级，redis跳跃表，底层代码最多是32级。。 特别感兴趣的话，和我要一下源代码（。net跳跃表的代码，如果不着急，后面讲数据结构和算法的时候，还会单独去讲 ）
mysql8 是多线程
分布式关系型数据库tidb (多线程)
~~~

![image-20210428223405607](%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0.assets/image-20210428223405607.png)



![image-20210428223420353](%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0.assets/image-20210428223420353.png)



redis 解决了两个问题：1.直接操作硬盘的问题

​                                       2.连接阻塞的问题，之前是io阻塞，系统在等待请求的时候，不能干其他的事情，而且每次只能阻塞等待请求，redis通过多路复用，由系统帮你监听多个连接，只要有事情要处理 ，系统会调用你的回调函数，把监听的事情交给了系统，释放了我们自己的代码-- 开启的是高速通道，之前一次只能处理一个请求，现在可以处理多个请求。。。  （不管是单线程的redis还是多线程的redis，最后执行那个指令的线程并且只要一个，）

![image-20210428223428329](%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0.assets/image-20210428223428329.png)

~~~shell
1.内存满了，会触发数据淘汰策略，释放资源
2.限流--讲lua，扩展，看一下实现代码  
### 限流lua代码如下
local times = redis.call('incr',KEYS[1])
if times == 1 then
  redis.call('expire',KEYS[1], ARGV[1])
end
 
if times > tonumber(ARGV[2]) then
  return 0
end
return 1
~~~

生产环境，都不支持key,因为消耗性能比较严重。。。内存满了之后会触发数据淘汰算法，可能会丢数据，但是不会让数据库宕机--- 可以配置

![image-20210428223436627](image-20210428223436627.png)



还有20个字节存放了其他的标识----- 自己百度查查，

zset只能根据分数来查询。。。 

redis。ngixn都是使用的多路复用，高并发场景--- 如果网络协议，socket,

dotnetty ---.net 版本的 netty框架

~~~shell
https://github.com/Azure/DotNetty
~~~



![image-20210428223457847](%E8%AF%BE%E5%A0%82%E7%AC%94%E8%AE%B0.assets/image-20210428223457847.png)

多路复用底层是系统提供

.net 里面还没有去使用linux系统里面的epool模型，可以使用select，redis可以做，c语言写

但是.net 还没有调用这种东西。。。 



学习redis--写api，用多了就熟悉

​                 原理--老师今天讲的。。。  写是写不了，面试，在工作中做层级比较高的时候，要调优的时候，才会用到，涉及架构的处理。。。 



Docker 中如果设置redis密码

挂载的时候，把配置文件改一下，挂载进去就行了。或者直接进容器改配置文件--- 

等下，把docker挂载启动redis配置和脚本放在下面 ：：



~~~shell
docker run -d -p 6379:6379  -v /myredis/conf/redis.conf:/usr/local/etc/redis/redis.conf   --name redis01 redis:6.0 redis-server /usr/local/etc/redis/redis.conf 
~~~

~~~shell
配置文件就是windows下面的配置文件就可以，然后存放到/myredis/conf/redis.conf 这个目录，就可以使用docker挂载了，然后可以设置密码什么的
~~~





